<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="shortcut icon" href="/images/img/favicon.webp"/><meta name="keywords" content="Blog RUA"/><meta name="description" content="Personal blog."/><meta name="author" content="Arthur,i@rua.plus"/><title>RUA - Docker-全面容器化！</title><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/39834862c769c308.css" as="style"/><link rel="stylesheet" href="/_next/static/css/39834862c769c308.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c2a527101433f11d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c2a527101433f11d.css" data-n-p=""/><link rel="preload" href="/_next/static/css/6e1d66a70b5d9fed.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e1d66a70b5d9fed.css"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script defer="" src="/_next/static/chunks/219-ddf2abc0472da9bd.js"></script><script defer="" src="/_next/static/chunks/419.d5302bfd9d8378c2.js"></script><script defer="" src="/_next/static/chunks/771.84a2737df445ba88.js"></script><script defer="" src="/_next/static/chunks/929.b2c0b4f7606bfefe.js"></script><script defer="" src="/_next/static/chunks/485-3e3bf066e6f4a6bd.js"></script><script defer="" src="/_next/static/chunks/189.ee2e569101c160eb.js"></script><script defer="" src="/_next/static/chunks/125.4ff7adc183744312.js"></script><script defer="" src="/_next/static/chunks/780.f3b2fc2ce5caea55.js"></script><script defer="" src="/_next/static/chunks/980.41f5e97cd35a6621.js"></script><script defer="" src="/_next/static/chunks/106.7a94988fd220337e.js"></script><script src="/_next/static/chunks/webpack-c08977534ec7c137.js" defer=""></script><script src="/_next/static/chunks/framework-5cd9e2157a4a6aee.js" defer=""></script><script src="/_next/static/chunks/main-472dbb675bbf7f67.js" defer=""></script><script src="/_next/static/chunks/pages/_app-a34fa0ed9496fbe8.js" defer=""></script><script src="/_next/static/chunks/84-43981acebe84e1d3.js" defer=""></script><script src="/_next/static/chunks/pages/p/%5Bslug%5D-684bfb16186b52fe.js" defer=""></script><script src="/_next/static/k6NIc4JfXUsE09z9QnALx/_buildManifest.js" defer=""></script><script src="/_next/static/k6NIc4JfXUsE09z9QnALx/_ssgManifest.js" defer=""></script><script src="/_next/static/k6NIc4JfXUsE09z9QnALx/_middlewareManifest.js" defer=""></script></head><body><script>(function setScript(initialValue) {
  var mql = window.matchMedia("(prefers-color-scheme: dark)");
  var systemPreference = mql.matches ? "dark" : "light";
  var persistedPreference;

  try {
    persistedPreference = localStorage.getItem("chakra-ui-color-mode");
  } catch (error) {
    console.log("Chakra UI: localStorage is not available. Color mode persistence might not work as expected");
  }

  var isInStorage = typeof persistedPreference === "string";
  var colorMode;

  if (isInStorage) {
    colorMode = persistedPreference;
  } else {
    colorMode = initialValue === "system" ? systemPreference : initialValue;
  }

  if (colorMode) {
    var root = document.documentElement;
    root.style.setProperty("--chakra-ui-color-mode", colorMode);
  }
})('light')</script><div id="__next"><style data-emotion="css-global 1r47v8">:host,:root{--chakra-ring-inset:var(--chakra-empty,/*!*/ /*!*/);--chakra-ring-offset-width:0px;--chakra-ring-offset-color:#fff;--chakra-ring-color:rgba(66, 153, 225, 0.6);--chakra-ring-offset-shadow:0 0 #0000;--chakra-ring-shadow:0 0 #0000;--chakra-space-x-reverse:0;--chakra-space-y-reverse:0;--chakra-colors-transparent:transparent;--chakra-colors-current:currentColor;--chakra-colors-black:#000000;--chakra-colors-white:#FFFFFF;--chakra-colors-whiteAlpha-50:rgba(255, 255, 255, 0.04);--chakra-colors-whiteAlpha-100:rgba(255, 255, 255, 0.06);--chakra-colors-whiteAlpha-200:rgba(255, 255, 255, 0.08);--chakra-colors-whiteAlpha-300:rgba(255, 255, 255, 0.16);--chakra-colors-whiteAlpha-400:rgba(255, 255, 255, 0.24);--chakra-colors-whiteAlpha-500:rgba(255, 255, 255, 0.36);--chakra-colors-whiteAlpha-600:rgba(255, 255, 255, 0.48);--chakra-colors-whiteAlpha-700:rgba(255, 255, 255, 0.64);--chakra-colors-whiteAlpha-800:rgba(255, 255, 255, 0.80);--chakra-colors-whiteAlpha-900:rgba(255, 255, 255, 0.92);--chakra-colors-blackAlpha-50:rgba(0, 0, 0, 0.04);--chakra-colors-blackAlpha-100:rgba(0, 0, 0, 0.06);--chakra-colors-blackAlpha-200:rgba(0, 0, 0, 0.08);--chakra-colors-blackAlpha-300:rgba(0, 0, 0, 0.16);--chakra-colors-blackAlpha-400:rgba(0, 0, 0, 0.24);--chakra-colors-blackAlpha-500:rgba(0, 0, 0, 0.36);--chakra-colors-blackAlpha-600:rgba(0, 0, 0, 0.48);--chakra-colors-blackAlpha-700:rgba(0, 0, 0, 0.64);--chakra-colors-blackAlpha-800:rgba(0, 0, 0, 0.80);--chakra-colors-blackAlpha-900:rgba(0, 0, 0, 0.92);--chakra-colors-gray-50:#F7FAFC;--chakra-colors-gray-100:#EDF2F7;--chakra-colors-gray-200:#E2E8F0;--chakra-colors-gray-300:#CBD5E0;--chakra-colors-gray-400:#A0AEC0;--chakra-colors-gray-500:#718096;--chakra-colors-gray-600:#4A5568;--chakra-colors-gray-700:#2D3748;--chakra-colors-gray-800:#1A202C;--chakra-colors-gray-900:#171923;--chakra-colors-red-50:#FFF5F5;--chakra-colors-red-100:#FED7D7;--chakra-colors-red-200:#FEB2B2;--chakra-colors-red-300:#FC8181;--chakra-colors-red-400:#F56565;--chakra-colors-red-500:#E53E3E;--chakra-colors-red-600:#C53030;--chakra-colors-red-700:#9B2C2C;--chakra-colors-red-800:#822727;--chakra-colors-red-900:#63171B;--chakra-colors-orange-50:#FFFAF0;--chakra-colors-orange-100:#FEEBC8;--chakra-colors-orange-200:#FBD38D;--chakra-colors-orange-300:#F6AD55;--chakra-colors-orange-400:#ED8936;--chakra-colors-orange-500:#DD6B20;--chakra-colors-orange-600:#C05621;--chakra-colors-orange-700:#9C4221;--chakra-colors-orange-800:#7B341E;--chakra-colors-orange-900:#652B19;--chakra-colors-yellow-50:#FFFFF0;--chakra-colors-yellow-100:#FEFCBF;--chakra-colors-yellow-200:#FAF089;--chakra-colors-yellow-300:#F6E05E;--chakra-colors-yellow-400:#ECC94B;--chakra-colors-yellow-500:#D69E2E;--chakra-colors-yellow-600:#B7791F;--chakra-colors-yellow-700:#975A16;--chakra-colors-yellow-800:#744210;--chakra-colors-yellow-900:#5F370E;--chakra-colors-green-50:#F0FFF4;--chakra-colors-green-100:#C6F6D5;--chakra-colors-green-200:#9AE6B4;--chakra-colors-green-300:#68D391;--chakra-colors-green-400:#48BB78;--chakra-colors-green-500:#38A169;--chakra-colors-green-600:#2F855A;--chakra-colors-green-700:#276749;--chakra-colors-green-800:#22543D;--chakra-colors-green-900:#1C4532;--chakra-colors-teal-50:#E6FFFA;--chakra-colors-teal-100:#B2F5EA;--chakra-colors-teal-200:#81E6D9;--chakra-colors-teal-300:#4FD1C5;--chakra-colors-teal-400:#38B2AC;--chakra-colors-teal-500:#319795;--chakra-colors-teal-600:#2C7A7B;--chakra-colors-teal-700:#285E61;--chakra-colors-teal-800:#234E52;--chakra-colors-teal-900:#1D4044;--chakra-colors-blue-50:#ebf8ff;--chakra-colors-blue-100:#bee3f8;--chakra-colors-blue-200:#90cdf4;--chakra-colors-blue-300:#63b3ed;--chakra-colors-blue-400:#4299e1;--chakra-colors-blue-500:#3182ce;--chakra-colors-blue-600:#2b6cb0;--chakra-colors-blue-700:#2c5282;--chakra-colors-blue-800:#2a4365;--chakra-colors-blue-900:#1A365D;--chakra-colors-cyan-50:#EDFDFD;--chakra-colors-cyan-100:#C4F1F9;--chakra-colors-cyan-200:#9DECF9;--chakra-colors-cyan-300:#76E4F7;--chakra-colors-cyan-400:#0BC5EA;--chakra-colors-cyan-500:#00B5D8;--chakra-colors-cyan-600:#00A3C4;--chakra-colors-cyan-700:#0987A0;--chakra-colors-cyan-800:#086F83;--chakra-colors-cyan-900:#065666;--chakra-colors-purple-50:#FAF5FF;--chakra-colors-purple-100:#E9D8FD;--chakra-colors-purple-200:#D6BCFA;--chakra-colors-purple-300:#B794F4;--chakra-colors-purple-400:#9F7AEA;--chakra-colors-purple-500:#805AD5;--chakra-colors-purple-600:#6B46C1;--chakra-colors-purple-700:#553C9A;--chakra-colors-purple-800:#44337A;--chakra-colors-purple-900:#322659;--chakra-colors-pink-50:#FFF5F7;--chakra-colors-pink-100:#FED7E2;--chakra-colors-pink-200:#FBB6CE;--chakra-colors-pink-300:#F687B3;--chakra-colors-pink-400:#ED64A6;--chakra-colors-pink-500:#D53F8C;--chakra-colors-pink-600:#B83280;--chakra-colors-pink-700:#97266D;--chakra-colors-pink-800:#702459;--chakra-colors-pink-900:#521B41;--chakra-colors-linkedin-50:#E8F4F9;--chakra-colors-linkedin-100:#CFEDFB;--chakra-colors-linkedin-200:#9BDAF3;--chakra-colors-linkedin-300:#68C7EC;--chakra-colors-linkedin-400:#34B3E4;--chakra-colors-linkedin-500:#00A0DC;--chakra-colors-linkedin-600:#008CC9;--chakra-colors-linkedin-700:#0077B5;--chakra-colors-linkedin-800:#005E93;--chakra-colors-linkedin-900:#004471;--chakra-colors-facebook-50:#E8F4F9;--chakra-colors-facebook-100:#D9DEE9;--chakra-colors-facebook-200:#B7C2DA;--chakra-colors-facebook-300:#6482C0;--chakra-colors-facebook-400:#4267B2;--chakra-colors-facebook-500:#385898;--chakra-colors-facebook-600:#314E89;--chakra-colors-facebook-700:#29487D;--chakra-colors-facebook-800:#223B67;--chakra-colors-facebook-900:#1E355B;--chakra-colors-messenger-50:#D0E6FF;--chakra-colors-messenger-100:#B9DAFF;--chakra-colors-messenger-200:#A2CDFF;--chakra-colors-messenger-300:#7AB8FF;--chakra-colors-messenger-400:#2E90FF;--chakra-colors-messenger-500:#0078FF;--chakra-colors-messenger-600:#0063D1;--chakra-colors-messenger-700:#0052AC;--chakra-colors-messenger-800:#003C7E;--chakra-colors-messenger-900:#002C5C;--chakra-colors-whatsapp-50:#dffeec;--chakra-colors-whatsapp-100:#b9f5d0;--chakra-colors-whatsapp-200:#90edb3;--chakra-colors-whatsapp-300:#65e495;--chakra-colors-whatsapp-400:#3cdd78;--chakra-colors-whatsapp-500:#22c35e;--chakra-colors-whatsapp-600:#179848;--chakra-colors-whatsapp-700:#0c6c33;--chakra-colors-whatsapp-800:#01421c;--chakra-colors-whatsapp-900:#001803;--chakra-colors-twitter-50:#E5F4FD;--chakra-colors-twitter-100:#C8E9FB;--chakra-colors-twitter-200:#A8DCFA;--chakra-colors-twitter-300:#83CDF7;--chakra-colors-twitter-400:#57BBF5;--chakra-colors-twitter-500:#1DA1F2;--chakra-colors-twitter-600:#1A94DA;--chakra-colors-twitter-700:#1681BF;--chakra-colors-twitter-800:#136B9E;--chakra-colors-twitter-900:#0D4D71;--chakra-colors-telegram-50:#E3F2F9;--chakra-colors-telegram-100:#C5E4F3;--chakra-colors-telegram-200:#A2D4EC;--chakra-colors-telegram-300:#7AC1E4;--chakra-colors-telegram-400:#47A9DA;--chakra-colors-telegram-500:#0088CC;--chakra-colors-telegram-600:#007AB8;--chakra-colors-telegram-700:#006BA1;--chakra-colors-telegram-800:#005885;--chakra-colors-telegram-900:#003F5E;--chakra-colors-home-bg:#f5f5fa;--chakra-borders-none:0;--chakra-borders-1px:1px solid;--chakra-borders-2px:2px solid;--chakra-borders-4px:4px solid;--chakra-borders-8px:8px solid;--chakra-fonts-heading:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--chakra-fonts-body:-apple-system,BlinkMacSystemFont,'Helvetica Neue',Helvetica,Segoe UI,Arial,Roboto,'PingFang SC',miui,'Hiragino Sans GB','Microsoft Yahei',sans-serif;--chakra-fonts-mono:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--chakra-fontSizes-xs:0.75rem;--chakra-fontSizes-sm:0.875rem;--chakra-fontSizes-md:1rem;--chakra-fontSizes-lg:1.125rem;--chakra-fontSizes-xl:1.25rem;--chakra-fontSizes-2xl:1.5rem;--chakra-fontSizes-3xl:1.875rem;--chakra-fontSizes-4xl:2.25rem;--chakra-fontSizes-5xl:3rem;--chakra-fontSizes-6xl:3.75rem;--chakra-fontSizes-7xl:4.5rem;--chakra-fontSizes-8xl:6rem;--chakra-fontSizes-9xl:8rem;--chakra-fontWeights-hairline:100;--chakra-fontWeights-thin:200;--chakra-fontWeights-light:300;--chakra-fontWeights-normal:400;--chakra-fontWeights-medium:500;--chakra-fontWeights-semibold:600;--chakra-fontWeights-bold:700;--chakra-fontWeights-extrabold:800;--chakra-fontWeights-black:900;--chakra-letterSpacings-tighter:-0.05em;--chakra-letterSpacings-tight:-0.025em;--chakra-letterSpacings-normal:0;--chakra-letterSpacings-wide:0.025em;--chakra-letterSpacings-wider:0.05em;--chakra-letterSpacings-widest:0.1em;--chakra-lineHeights-3:.75rem;--chakra-lineHeights-4:1rem;--chakra-lineHeights-5:1.25rem;--chakra-lineHeights-6:1.5rem;--chakra-lineHeights-7:1.75rem;--chakra-lineHeights-8:2rem;--chakra-lineHeights-9:2.25rem;--chakra-lineHeights-10:2.5rem;--chakra-lineHeights-normal:normal;--chakra-lineHeights-none:1;--chakra-lineHeights-shorter:1.25;--chakra-lineHeights-short:1.375;--chakra-lineHeights-base:1.5;--chakra-lineHeights-tall:1.625;--chakra-lineHeights-taller:2;--chakra-radii-none:0;--chakra-radii-sm:0.125rem;--chakra-radii-base:0.25rem;--chakra-radii-md:0.375rem;--chakra-radii-lg:0.5rem;--chakra-radii-xl:0.75rem;--chakra-radii-2xl:1rem;--chakra-radii-3xl:1.5rem;--chakra-radii-full:9999px;--chakra-space-1:0.25rem;--chakra-space-2:0.5rem;--chakra-space-3:0.75rem;--chakra-space-4:1rem;--chakra-space-5:1.25rem;--chakra-space-6:1.5rem;--chakra-space-7:1.75rem;--chakra-space-8:2rem;--chakra-space-9:2.25rem;--chakra-space-10:2.5rem;--chakra-space-12:3rem;--chakra-space-14:3.5rem;--chakra-space-16:4rem;--chakra-space-20:5rem;--chakra-space-24:6rem;--chakra-space-28:7rem;--chakra-space-32:8rem;--chakra-space-36:9rem;--chakra-space-40:10rem;--chakra-space-44:11rem;--chakra-space-48:12rem;--chakra-space-52:13rem;--chakra-space-56:14rem;--chakra-space-60:15rem;--chakra-space-64:16rem;--chakra-space-72:18rem;--chakra-space-80:20rem;--chakra-space-96:24rem;--chakra-space-px:1px;--chakra-space-0\.5:0.125rem;--chakra-space-1\.5:0.375rem;--chakra-space-2\.5:0.625rem;--chakra-space-3\.5:0.875rem;--chakra-shadows-xs:0 0 0 1px rgba(0, 0, 0, 0.05);--chakra-shadows-sm:0 1px 2px 0 rgba(0, 0, 0, 0.05);--chakra-shadows-base:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);--chakra-shadows-md:0 4px 6px -1px rgba(0, 0, 0, 0.1),0 2px 4px -1px rgba(0, 0, 0, 0.06);--chakra-shadows-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1),0 4px 6px -2px rgba(0, 0, 0, 0.05);--chakra-shadows-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1),0 10px 10px -5px rgba(0, 0, 0, 0.04);--chakra-shadows-2xl:0 25px 50px -12px rgba(0, 0, 0, 0.25);--chakra-shadows-outline:0 0 0 3px rgba(66, 153, 225, 0.6);--chakra-shadows-inner:inset 0 2px 4px 0 rgba(0,0,0,0.06);--chakra-shadows-none:none;--chakra-shadows-dark-lg:rgba(0, 0, 0, 0.1) 0px 0px 0px 1px,rgba(0, 0, 0, 0.2) 0px 5px 10px,rgba(0, 0, 0, 0.4) 0px 15px 40px;--chakra-shadows-card:0px 4px 8px rgba(0, 0, 0, 0.04),0px 0px 2px rgba(0, 0, 0, 0.06),0px 0px 1px rgba(0, 0, 0, 0.04);--chakra-sizes-1:0.25rem;--chakra-sizes-2:0.5rem;--chakra-sizes-3:0.75rem;--chakra-sizes-4:1rem;--chakra-sizes-5:1.25rem;--chakra-sizes-6:1.5rem;--chakra-sizes-7:1.75rem;--chakra-sizes-8:2rem;--chakra-sizes-9:2.25rem;--chakra-sizes-10:2.5rem;--chakra-sizes-12:3rem;--chakra-sizes-14:3.5rem;--chakra-sizes-16:4rem;--chakra-sizes-20:5rem;--chakra-sizes-24:6rem;--chakra-sizes-28:7rem;--chakra-sizes-32:8rem;--chakra-sizes-36:9rem;--chakra-sizes-40:10rem;--chakra-sizes-44:11rem;--chakra-sizes-48:12rem;--chakra-sizes-52:13rem;--chakra-sizes-56:14rem;--chakra-sizes-60:15rem;--chakra-sizes-64:16rem;--chakra-sizes-72:18rem;--chakra-sizes-80:20rem;--chakra-sizes-96:24rem;--chakra-sizes-px:1px;--chakra-sizes-0\.5:0.125rem;--chakra-sizes-1\.5:0.375rem;--chakra-sizes-2\.5:0.625rem;--chakra-sizes-3\.5:0.875rem;--chakra-sizes-max:max-content;--chakra-sizes-min:min-content;--chakra-sizes-full:100%;--chakra-sizes-3xs:14rem;--chakra-sizes-2xs:16rem;--chakra-sizes-xs:20rem;--chakra-sizes-sm:24rem;--chakra-sizes-md:28rem;--chakra-sizes-lg:32rem;--chakra-sizes-xl:36rem;--chakra-sizes-2xl:42rem;--chakra-sizes-3xl:48rem;--chakra-sizes-4xl:56rem;--chakra-sizes-5xl:64rem;--chakra-sizes-6xl:72rem;--chakra-sizes-7xl:80rem;--chakra-sizes-8xl:90rem;--chakra-sizes-container-sm:640px;--chakra-sizes-container-md:768px;--chakra-sizes-container-lg:1024px;--chakra-sizes-container-xl:1280px;--chakra-zIndices-hide:-1;--chakra-zIndices-auto:auto;--chakra-zIndices-base:0;--chakra-zIndices-docked:10;--chakra-zIndices-dropdown:1000;--chakra-zIndices-sticky:1100;--chakra-zIndices-banner:1200;--chakra-zIndices-overlay:1300;--chakra-zIndices-modal:1400;--chakra-zIndices-popover:1500;--chakra-zIndices-skipLink:1600;--chakra-zIndices-toast:1700;--chakra-zIndices-tooltip:1800;--chakra-transition-property-common:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform;--chakra-transition-property-colors:background-color,border-color,color,fill,stroke;--chakra-transition-property-dimensions:width,height;--chakra-transition-property-position:left,right,top,bottom;--chakra-transition-property-background:background-color,background-image,background-position;--chakra-transition-easing-ease-in:cubic-bezier(0.4, 0, 1, 1);--chakra-transition-easing-ease-out:cubic-bezier(0, 0, 0.2, 1);--chakra-transition-easing-ease-in-out:cubic-bezier(0.4, 0, 0.2, 1);--chakra-transition-duration-ultra-fast:50ms;--chakra-transition-duration-faster:100ms;--chakra-transition-duration-fast:150ms;--chakra-transition-duration-normal:200ms;--chakra-transition-duration-slow:300ms;--chakra-transition-duration-slower:400ms;--chakra-transition-duration-ultra-slow:500ms;--chakra-blur-none:0;--chakra-blur-sm:4px;--chakra-blur-base:8px;--chakra-blur-md:12px;--chakra-blur-lg:16px;--chakra-blur-xl:24px;--chakra-blur-2xl:40px;--chakra-blur-3xl:64px;}</style><style data-emotion="css-global 1jqlf9g">html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;-moz-osx-font-smoothing:grayscale;touch-action:manipulation;}body{position:relative;min-height:100%;font-feature-settings:'kern';}*,*::before,*::after{border-width:0;border-style:solid;box-sizing:border-box;}main{display:block;}hr{border-top-width:1px;box-sizing:content-box;height:0;overflow:visible;}pre,code,kbd,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:1em;}a{background-color:transparent;color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit;}abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;}b,strong{font-weight:bold;}small{font-size:80%;}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;}sub{bottom:-0.25em;}sup{top:-0.5em;}img{border-style:none;}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;}button,input{overflow:visible;}button,select{text-transform:none;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;}fieldset{padding:0.35em 0.75em 0.625em;}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;}progress{vertical-align:baseline;}textarea{overflow:auto;}[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}[type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{-webkit-appearance:none!important;}input[type="number"]{-moz-appearance:textfield;}[type="search"]{-webkit-appearance:textfield;outline-offset:-2px;}[type="search"]::-webkit-search-decoration{-webkit-appearance:none!important;}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;}details{display:block;}summary{display:-webkit-box;display:-webkit-list-item;display:-ms-list-itembox;display:list-item;}template{display:none;}[hidden]{display:none!important;}body,blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0;}button{background:transparent;padding:0;}fieldset{margin:0;padding:0;}ol,ul{margin:0;padding:0;}textarea{resize:vertical;}button,[role="button"]{cursor:pointer;}button::-moz-focus-inner{border:0!important;}table{border-collapse:collapse;}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit;}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit;}img,svg,video,canvas,audio,iframe,embed,object{display:block;}img,video{max-width:100%;height:auto;}[data-js-focus-visible] :focus:not([data-focus-visible-added]){outline:none;box-shadow:none;}select::-ms-expand{display:none;}</style><style data-emotion="css-global 1of8e4g">body{font-family:var(--chakra-fonts-body);color:var(--chakra-colors-gray-800);background:var(--chakra-colors-white);transition-property:background-color;transition-duration:var(--chakra-transition-duration-normal);line-height:var(--chakra-lineHeights-base);}*::-webkit-input-placeholder{color:var(--chakra-colors-gray-400);}*::-moz-placeholder{color:var(--chakra-colors-gray-400);}*:-ms-input-placeholder{color:var(--chakra-colors-gray-400);}*::placeholder{color:var(--chakra-colors-gray-400);}*,*::before,::after{border-color:var(--chakra-colors-gray-200);word-wrap:break-word;}html,body{background:var(--chakra-colors-home-bg);}img,#write iframe{-webkit-filter:unset;filter:unset;transition-property:filter;transition-duration:var(--chakra-transition-duration-normal);}div{transition-property:background-color;transition-duration:var(--chakra-transition-duration-normal);}</style><style data-emotion="css 1ghv3an">.css-1ghv3an{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;height:unset;overflow:auto;-webkit-box-flex-flow:column;-webkit-flex-flow:column;-ms-flex-flow:column;flex-flow:column;-webkit-padding-start:0.5rem;padding-inline-start:0.5rem;-webkit-padding-end:0.5rem;padding-inline-end:0.5rem;}@media screen and (min-width: 30em){.css-1ghv3an{height:unset;-webkit-box-flex-flow:column;-webkit-flex-flow:column;-ms-flex-flow:column;flex-flow:column;}}@media screen and (min-width: 48em){.css-1ghv3an{height:100vh;-webkit-box-flex-flow:row;-webkit-flex-flow:row;-ms-flex-flow:row;flex-flow:row;}}</style><div class="css-1ghv3an"><style data-emotion="css xte4wg">.css-xte4wg{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:unset;white-space:nowrap;vertical-align:middle;outline:2px solid transparent;outline-offset:2px;width:auto;line-height:1.2;border-radius:var(--chakra-radii-md);font-weight:var(--chakra-fontWeights-semibold);transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-normal);height:var(--chakra-sizes-12);min-width:var(--chakra-sizes-12);font-size:var(--chakra-fontSizes-lg);-webkit-padding-start:var(--chakra-space-6);padding-inline-start:var(--chakra-space-6);-webkit-padding-end:var(--chakra-space-6);padding-inline-end:var(--chakra-space-6);background:var(--chakra-colors-gray-100);margin-top:1rem;top:3rem;}@media screen and (min-width: 30em){.css-xte4wg{position:unset;margin-top:1rem;}}@media screen and (min-width: 48em){.css-xte4wg{position:-webkit-sticky;position:sticky;margin-top:3rem;}}.css-xte4wg:focus,.css-xte4wg[data-focus]{box-shadow:var(--chakra-shadows-outline);}.css-xte4wg[disabled],.css-xte4wg[aria-disabled=true],.css-xte4wg[data-disabled]{opacity:0.4;cursor:not-allowed;box-shadow:var(--chakra-shadows-none);}.css-xte4wg:hover,.css-xte4wg[data-hover]{background:var(--chakra-colors-gray-200);}.css-xte4wg:hover[disabled],.css-xte4wg[data-hover][disabled],.css-xte4wg:hover[aria-disabled=true],.css-xte4wg[data-hover][aria-disabled=true],.css-xte4wg:hover[data-disabled],.css-xte4wg[data-hover][data-disabled]{background:var(--chakra-colors-gray-100);}.css-xte4wg:active,.css-xte4wg[data-active]{background:var(--chakra-colors-gray-300);}</style><button type="button" class="chakra-button css-xte4wg">BACK</button><style data-emotion="css a06krq">.css-a06krq{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;width:var(--chakra-sizes-full);-webkit-box-flex-flow:column;-webkit-flex-flow:column;-ms-flex-flow:column;flex-flow:column;-webkit-padding-start:unset;padding-inline-start:unset;-webkit-padding-end:unset;padding-inline-end:unset;}@media screen and (min-width: 30em){.css-a06krq{width:var(--chakra-sizes-full);-webkit-padding-start:unset;padding-inline-start:unset;-webkit-padding-end:unset;padding-inline-end:unset;}}@media screen and (min-width: 48em){.css-a06krq{width:55rem;-webkit-padding-start:1.5rem;padding-inline-start:1.5rem;-webkit-padding-end:1.5rem;padding-inline-end:1.5rem;}}@media screen and (min-width: 62em){.css-a06krq{width:55rem;}}@media screen and (min-width: 80em){.css-a06krq{width:55rem;}}@media screen and (min-width: 96em){.css-a06krq{width:68rem;}}</style><div class="css-a06krq"><style data-emotion="css 1if659q">.css-1if659q{border-radius:10px;margin-top:1rem;box-shadow:var(--chakra-shadows-lg);background:var(--chakra-colors-white);overflow:hidden;-webkit-flex:1;-ms-flex:1;flex:1;}@media screen and (min-width: 30em){.css-1if659q{margin-top:1rem;}}@media screen and (min-width: 48em){.css-1if659q{margin-top:3rem;}}</style><div class="css-1if659q"><style data-emotion="css 81xunj">.css-81xunj{padding:1rem;}@media screen and (min-width: 30em){.css-81xunj{padding:1rem;}}@media screen and (min-width: 48em){.css-81xunj{padding:2rem;}}</style><article class="css-81xunj"><header class="css-0"><style data-emotion="css 1m7qnzk">.css-1m7qnzk{font-family:var(--chakra-fonts-heading);font-weight:var(--chakra-fontWeights-bold);font-size:var(--chakra-fontSizes-3xl);line-height:1.33;margin-bottom:1rem;color:rgba(0, 0, 0, 0.85);}@media screen and (min-width: 48em){.css-1m7qnzk{font-size:var(--chakra-fontSizes-4xl);line-height:1.2;}}</style><h1 class="chakra-heading css-1m7qnzk">Docker-全面容器化！</h1><style data-emotion="css acwcvw">.css-acwcvw{margin-bottom:1rem;}</style><div class="css-acwcvw"><style data-emotion="css 1kpd5c2">.css-1kpd5c2{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;vertical-align:top;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;max-width:100%;font-weight:var(--chakra-fontWeights-medium);line-height:1.2;outline:2px solid transparent;outline-offset:2px;min-height:1.5rem;min-width:1.5rem;font-size:var(--chakra-fontSizes-sm);border-radius:var(--chakra-radii-md);-webkit-padding-start:var(--chakra-space-2);padding-inline-start:var(--chakra-space-2);-webkit-padding-end:var(--chakra-space-2);padding-inline-end:var(--chakra-space-2);background:var(--chakra-colors-gray-100);color:var(--chakra-colors-gray-800);}.css-1kpd5c2:focus,.css-1kpd5c2[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><span class="css-1kpd5c2">Linux</span></div><style data-emotion="css x8djax">.css-x8djax{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:var(--chakra-colors-gray-600);}</style><div class="css-x8djax"><style data-emotion="css 1lr2xj">.css-1lr2xj{width:1em;height:1em;display:inline-block;line-height:1em;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;color:currentColor;margin-right:0.5rem;}</style><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" focusable="false" class="chakra-icon css-1lr2xj" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><style data-emotion="css 129gw94">.css-129gw94{line-height:0;}</style><time dateTime="2019-12-19T11:11:33.000Z" class="css-129gw94">2019/12/19</time></div></header><style data-emotion="css i51og3">.css-i51og3{margin-top:2rem;}</style><section id="write" class="css-i51og3"><p>自上篇<style data-emotion="css wox0k7">.css-wox0k7{transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-fast);transition-timing-function:var(--chakra-transition-easing-ease-out);cursor:pointer;-webkit-text-decoration:none;text-decoration:none;outline:2px solid transparent;outline-offset:2px;color:inherit;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-wox0k7:hover,.css-wox0k7[data-hover]{-webkit-text-decoration:underline;text-decoration:underline;}.css-wox0k7:focus,.css-wox0k7[data-focus]{box-shadow:var(--chakra-shadows-outline);}</style><a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://www.defectink.com/defect/docker-build-own-images.html">Docker - 构建属于自己的镜像<style data-emotion="css 2y6psj">.css-2y6psj{width:1em;height:1em;display:inline-block;line-height:1em;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;color:currentColor;vertical-align:middle;-webkit-margin-start:2px;margin-inline-start:2px;-webkit-margin-end:2px;margin-inline-end:2px;}</style><svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a>以来，发现Docker非常的有意思。主要是非常的方便，并且在可以跨平台的情况下部署环境对于以后迁移也是一件极其有利的事。研究了Dockerfile的编写以及实践。一些基础的实践之后，对于Docker的工作方式以及操作命令都有了一些熟悉。也逐渐了发现了它的一些优点。</p>
<p>翻开自己的旧机器里的多种环境交杂在一起的配置，时间长了连配置文件在哪都找不到了。管理起来比较复杂。那些服务器的管理面板并不是很喜欢，而且相对于Docker来说，管理面板只是简化了部署的操作，并没有达到方便管理的目的。到最后可能它的软件目录，镜像源都是按照它的想法去放的。对于自己并没有完全的掌控。当然不能完全拿管理面板与Docker来相比，二者完全是两种技术。只是相较于方便管理这方面来对比一下。</p>
<p>而最近研究的Docker，无疑是最满意的了。在保持宿主机不乱的情况下，可以完全的掌控自己的运行环境。于是就有了将自己目前跑了挺长时间的一套blog环境都迁移到Docker上。对于以后若是迁移机器也会更加的方便。</p>
<h2 id="涉及到的操作">涉及到的操作</h2>
<ul>
<li>Dockerfile</li>
<li>docker-compose.yml</li>
<li>apache virtualhost</li>
<li>php-fpm</li>
<li>http2</li>
<li>apache https</li>
<li>certbot with docker</li>
<li>apache proxy</li>
</ul>
<h2 id="目前环境">目前环境</h2>
<p>先来简单看下当前跑在机器上的环境：</p>
<p>基本的LAMP环境，加上一些自定义的应用，与一个服务器监控软件。其中apache有多个虚拟主机，全部都使用了https。</p>
<p>咋一看是一套很简单的环境，其中apache配置稍多一点。但是实际在迁移到Docker的操作起来还是比较复杂的。并且为了镜像的最小化，apache基于的镜像都是alpine。配置与常用的Ubuntu略有不同。</p>
<h2 id="容器化">容器化</h2>
<h3 id="思路">思路</h3>
<p>将多个运行LAMP分别拆分出三个运行环境，使用docker-compose来捆绑运行。</p>
<p>目录树</p>
<pre><style data-emotion="css 19bp9bt">.css-19bp9bt{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;position:absolute;white-space:nowrap;vertical-align:middle;outline:2px solid transparent;outline-offset:2px;width:auto;line-height:1.2;border-radius:var(--chakra-radii-md);font-weight:var(--chakra-fontWeights-semibold);transition-property:var(--chakra-transition-property-common);transition-duration:var(--chakra-transition-duration-normal);height:var(--chakra-sizes-6);min-width:var(--chakra-sizes-6);font-size:var(--chakra-fontSizes-xs);-webkit-padding-start:var(--chakra-space-2);padding-inline-start:var(--chakra-space-2);-webkit-padding-end:var(--chakra-space-2);padding-inline-end:var(--chakra-space-2);background:var(--chakra-colors-teal-500);color:var(--chakra-colors-white);top:5px;right:5px;}.css-19bp9bt:focus,.css-19bp9bt[data-focus]{box-shadow:var(--chakra-shadows-outline);}.css-19bp9bt[disabled],.css-19bp9bt[aria-disabled=true],.css-19bp9bt[data-disabled]{opacity:0.4;cursor:not-allowed;box-shadow:var(--chakra-shadows-none);}.css-19bp9bt:hover,.css-19bp9bt[data-hover]{background:var(--chakra-colors-teal-600);}.css-19bp9bt:hover[disabled],.css-19bp9bt[data-hover][disabled],.css-19bp9bt:hover[aria-disabled=true],.css-19bp9bt[data-hover][aria-disabled=true],.css-19bp9bt:hover[data-disabled],.css-19bp9bt[data-hover][data-disabled]{background:var(--chakra-colors-teal-500);}.css-19bp9bt:active,.css-19bp9bt[data-active]{background:var(--chakra-colors-teal-700);}</style><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-arduino">.
├── apache
│   ├── Dockerfile
│   ├── httpd.conf
│   └── sites
│       ├── <span class="hljs-number">000</span>-<span class="hljs-keyword">default</span>-ssl.conf
│       └── <span class="hljs-number">000</span>-<span class="hljs-keyword">default</span>.conf
├── docker-compose.yml
├── mysql
│   └── backup
├── php
│   └── Dockerfile
└── www
    └── html
        └── index.php
</code></pre>
<p>首先创建一个用于存放整个运行环境的<code>Docker</code>父文件夹。然后根据不同的镜像来划分不同的子文件夹，子文件夹内存放的就是各个镜像的<code>Dockerfile</code>与配置文件等。将docker-compose.yml存放与父目录下。</p>
<p>apache与php-fpm通信借助Docker的网络，实现内部的通信。</p>
<h2 id="apahce">Apahce</h2>
<p>在当前的apache目录下，主要文件夹的划分为<code>Dockerfile</code>、<code>httpd.conf</code>和sites文件夹。</p>
<h3 id="dockerfile">Dockerfile</h3>
<p>虽然httpd有了一个单独的镜像，但是还是需要使用Dockerfile来对其进行自定义配置。为了尽量减小镜像的大小。这里使用基于alpine的apache。</p>
<p>在Docker hub中的<a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://hub.docker.com/_/httpd">httpd<svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a>当前支持的tag：</p>
<p><picture data-rmiz-wrap="visible"><style data-emotion="css 185nr5j">.css-185nr5j{object-fit:cover;border-radius:10px;-webkit-filter:blur(20px);filter:blur(20px);transition-duration:var(--chakra-transition-duration-slower);height:100%;}</style><img alt="Post image" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" class="chakra-image css-185nr5j"/><button aria-label="Zoom image" data-rmiz-btn-open="true"></button></picture></p>
<p>整个Dockerfile：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-dockerfile">FROM httpd:alpine
RUN sed -i &#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27; /etc/apk/repositories \
	&amp;&amp; apk update \
        &amp;&amp; apk upgrade
COPY sites/ /usr/local/apache2/conf/sites/
COPY httpd.conf /usr/local/apache2/conf/httpd.conf
</code></pre>
<p>所以<code>FROM</code>里使用的就是带alpine的tag了。我还尝试过测试使用基于alpine的空载运行apache大概节约了1MB的内存。</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">176d166ee52a        testa               0.00%             4.484MiB / 3.607GiB   0.12%         
3dac39c11385        <span class="hljs-built_in">test</span>                0.00%             5.664MiB / 3.607GiB   0.15%         
</code></pre>
<p>对于跑在国内的机器上，alpine也有国内的源。并且替换的也很简单，一句话就好了。这样在后续的更新源和安装软件就没有那么苦恼了。</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">sed -i <span class="hljs-string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories
</code></pre>
<p>剩下的<code>COPY</code>就是复制自定义的配置文件到容器里去了。</p>
<h3 id="配置文件">配置文件</h3>
<p>首先，之前的环境中apache是有多个虚拟主机，并且每个主机都启用了ssl以及一些其他的配置。所以第一步是需要修改容器的配置文件。也就是要先获取默认的配置文件。</p>
<p>优雅的获取apache默认配置文件：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">docker run --<span class="hljs-built_in">rm</span> httpd:2.4 <span class="hljs-built_in">cat</span> /usr/local/apache2/conf/httpd.conf &gt; httpd.conf
</code></pre>
<p>默认的ssl配置文件：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">docker run --<span class="hljs-built_in">rm</span> httpd:2.4 <span class="hljs-built_in">cat</span> /usr/local/apache2/conf/extra/httpd-ssl.conf &gt; ssl.conf
</code></pre>
<p>容器的配置文件路径：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">/usr/local/apache2/conf/httpd.conf
</code></pre>
<p>获取到了默认的配置文件之后，在apache的文件夹内可以先自定义<code>httpd.conf</code>。并且尝试启动一次，没用问题后可以继续配置虚拟主机。</p>
<p>由于不同的站点都交给了虚拟主机的配置文件来处理。所以<code>httpd.conf</code>主要是负责一些mod的配置，和一些全局的配置了。还有就是将余下的配置文件<code>Include</code>进来了。</p>
<p>后期还有需要添加更多的虚拟主机的配置文件，到时候一个一个的<code>Include</code>操作太过繁琐。所以创建个专门存放配置文件的文件夹，再在<code>httpd.conf</code>里将整个文件夹<code>Include</code>进去。这样就最简单的解决了操作繁琐的问题。</p>
<p>创建一个<code>sites</code>文件夹用于存放配置文件，<code>COPY</code>到容器内相应的目录：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-ruby">COPY sites/ <span class="hljs-regexp">/usr/local</span><span class="hljs-regexp">/apache2/conf</span><span class="hljs-regexp">/sites/</span>
</code></pre>
<p>在<code>httpd.conf</code>中相应的引入：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">Include /usr/local/apache2/conf/sites/*.conf
</code></pre>
<p>{*}这一操作方法还是学自Ubuntu下的apache，它的配置目录下有两个文件夹<code>sites-available</code>和<code>sites-enabled</code>。在主要的apache2.conf中引入配置文件。</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-http"># Include generic snippets of statements
IncludeOptional conf-enabled/*.conf

# Include the virtual host configurations:
IncludeOptional sites-enabled/*.conf
</code></pre>
<p><code>httpd.conf</code>中的虚拟主机配置不需要修改了。所有的站点可以都在Include中的配置文件中准备。基本上<code>httpd.conf</code>就是为引入配置文件和启用mod所准备的。</p>
<h3 id="module">Module</h3>
<p>在基于alpine中的apache，所有的mod加载都写在了配置文件<code>httpd.conf</code>里。只需要取消注释就可以加载/启用模组了。</p>
<p>这次添加的module：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">LoadModule deflate_module modules/mod_deflate.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_connect_module modules/mod_proxy_connect.so
LoadModule proxy_ftp_module modules/mod_proxy_ftp.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule http2_module modules/mod_http2.so
LoadModule proxy_http2_module modules/mod_proxy_http2.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
<span class="hljs-comment">#LoadModule mpm_prefork_module modules/mod_mpm_prefork.so</span>
</code></pre>
<p>这些mod都是作用于何？</p>
<ul>
<li>
<p>mod_deflate是一个压缩算法。</p>
</li>
<li>
<p>mod_socache_shmcb共享对象缓存提供程序。</p>
</li>
<li>
<p>因为需要配置反代和与php-fpm工作，所以需要启用多个proxy配置文件。</p>
</li>
<li>
<p>因为需要用到http2，所以工作模式得修改为event。同时注释掉默认的工作模式prefork。自然也需要mod_http2</p>
</li>
<li>
<p>https是不可或缺的，所以mod_ssl不可缺少。</p>
</li>
<li>
<p>后续的博客需要用到伪静态，mod_rewrite也不可少。</p>
</li>
<li>
<p>在最近也添加了多个header头，需要用到mod_headers。</p>
</li>
</ul>
<blockquote>
<p>info：根据自己需要启用module是一个良好的习惯，过多的module会影响性能。</p>
</blockquote>
<h3 id="虚拟主机">虚拟主机</h3>
<p>前面提到，专门创建了一个sites文件夹来存放虚拟主机的配置文件，目前sites文件夹还是空的。既然<code>httpd.conf</code>以及准备就绪，那么接下来就是填满sites文件夹了。</p>
<p>在还未添加虚拟主机时，默认的站点配置文件全部都写在<code>httpd.conf</code>里。默认的根目录在htdocs。所以在第一次启动测试时，访问的时这里的html文件。</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-arduino">DocumentRoot <span class="hljs-string">&quot;/usr/local/apache2/htdocs&quot;</span>
</code></pre>
<p>这里的配置可以不用动，全部操作交给虚拟主机就好。</p>
<p>整个虚拟主机（default.conf）配置文件：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-ruby">&lt;VirtualHost *<span class="hljs-symbol">:</span><span class="hljs-number">80</span>&gt;
ProtocolsHonorOrder On
Protocols h2 h2c
Header set X-Frame-Options <span class="hljs-string">&quot;SAMEORIGIN&quot;</span>
Header always set Strict-Transport-Security <span class="hljs-string">&quot;max-age=63072000; includeSubdomains;&quot;</span>
Header set Content-Security-Policy <span class="hljs-string">&quot;default-src &#x27;self&#x27; https://cdn.defectink.com; script-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27; https://maxcdn.bootstrapcdn.com https://ajax.googleapis.com https://cdn.defectink.com; img-src *; style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; https://cdn.defectink.com https://maxcdn.bootstrapcdn.com https://fonts.googleapis.com/; font-src &#x27;self&#x27; https://cdn.defectink.com https://fonts.gstatic.com/ https://maxcdn.bootstrapcdn.com; form-action &#x27;self&#x27; https://cdn.defectink.com; upgrade-insecure-requests;&quot;</span>
Header set X-Content-Type-Options nosniff
Header always set Referrer-Policy <span class="hljs-string">&quot;no-referrer-when-downgrade&quot;</span>
Header always set Feature-Policy <span class="hljs-string">&quot;vibrate &#x27;self&#x27;; sync-xhr &#x27;self&#x27; https://cdn.defectink.com https://www.defectink.com&quot;</span>
    <span class="hljs-comment"># Proxy .php requests to port 9000 of the php-fpm container</span>
    ProxyPassMatch ^<span class="hljs-regexp">/(.*\.php(/</span>.*)<span class="hljs-string">?)</span><span class="hljs-variable">$ </span><span class="hljs-symbol">fcgi:</span>/<span class="hljs-regexp">/php:9000/var</span><span class="hljs-regexp">/www/html</span><span class="hljs-regexp">/$1
    ServerName www.defectink.com
    DocumentRoot /var</span><span class="hljs-regexp">/www/html</span><span class="hljs-regexp">/
    &lt;Directory /var</span><span class="hljs-regexp">/www/html</span><span class="hljs-regexp">/&gt;
        DirectoryIndex index.php
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    &lt;/</span>Directory&gt;
    <span class="hljs-comment"># Send apache logs to stdout and stderr</span>
    CustomLog /<span class="hljs-built_in">proc</span>/<span class="hljs-keyword">self</span>/fd/<span class="hljs-number">1</span> common
    ErrorLog /<span class="hljs-built_in">proc</span>/<span class="hljs-keyword">self</span>/fd/<span class="hljs-number">2</span>
RewriteEngine on
RewriteCond <span class="hljs-string">%{SERVER_NAME}</span> =www.defectink.com
RewriteRule ^ <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
&lt;/</span>VirtualHost&gt;
</code></pre>
<h4 id="虚拟主机优先级">虚拟主机优先级</h4>
<p>在apache中，虚拟主机的配置文件是拥有优先级的。优先级的意思就是，当一个域名指向当前机器的ip，而配置文件中没有绑定的ServerName时，默认被引导到的页面。</p>
<p>优先级的顺序是根据虚拟主机的配置文件名来决定的。名称首字母越靠前，优先级越高。使用数字开头将大于子母开头。</p>
<blockquote>
<p>000-default will be the default, because it goes “numbers, then letters”.</p>
</blockquote>
<p>可以使用命令来查看当前的默认站点：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">httpd -S
</code></pre>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">apache2ctl -S
</code></pre>
<h3 id="ssl">SSL</h3>
<p>这里的ssl配置文件是来自于容器内的默认配置文件，使用上述的方法可以很方便的导出。</p>
<p>整个ssl（default-ssl.conf）配置文件：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">Listen 443

SSLCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
SSLProxyCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
SSLHonorCipherOrder on 
SSLProtocol all -SSLv3
SSLProxyProtocol all -SSLv3
SSLPassPhraseDialog  <span class="hljs-built_in">builtin</span>
SSLSessionCache        <span class="hljs-string">&quot;shmcb:/usr/local/apache2/logs/ssl_scache(512000)&quot;</span>
SSLSessionCacheTimeout  300

&lt;VirtualHost *:443&gt;
ProtocolsHonorOrder On
Protocols h2 h2c
Header <span class="hljs-built_in">set</span> X-Frame-Options <span class="hljs-string">&quot;SAMEORIGIN&quot;</span>
Header always <span class="hljs-built_in">set</span> Strict-Transport-Security <span class="hljs-string">&quot;max-age=63072000; includeSubdomains;&quot;</span>
Header <span class="hljs-built_in">set</span> Content-Security-Policy <span class="hljs-string">&quot;default-src &#x27;self&#x27; https://cdn.defectink.com; script-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27; https://maxcdn.bootstrapcdn.com https://ajax.googleapis.com https://cdn.defectink.com; img-src *; style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; https://cdn.defectink.com https://maxcdn.bootstrapcdn.com https://fonts.googleapis.com/; font-src &#x27;self&#x27; https://cdn.defectink.com https://fonts.gstatic.com/ https://maxcdn.bootstrapcdn.com; form-action &#x27;self&#x27; https://cdn.defectink.com; upgrade-insecure-requests;&quot;</span>
Header <span class="hljs-built_in">set</span> X-Content-Type-Options nosniff
Header always <span class="hljs-built_in">set</span> Referrer-Policy <span class="hljs-string">&quot;no-referrer-when-downgrade&quot;</span>
Header always <span class="hljs-built_in">set</span> Feature-Policy <span class="hljs-string">&quot;vibrate &#x27;self&#x27;; sync-xhr &#x27;self&#x27; https://cdn.defectink.com https://www.defectink.com&quot;</span>
<span class="hljs-comment"># Proxy .php requests to port 9000 of the php-fpm container</span>
ProxyPassMatch ^/(.*\.php(/.*)?)$ fcgi://php:9000/var/www/html/<span class="hljs-variable">$1</span>
<span class="hljs-comment"># General setup for the virtual host</span>
DocumentRoot <span class="hljs-string">&quot;/var/www/html/&quot;</span>
ServerName www.defectink.com:443
ServerAdmin i@defect.ink
    &lt;Directory /var/www/html/&gt;
        DirectoryIndex index.php
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    &lt;/Directory&gt;
ErrorLog /proc/self/fd/2
TransferLog /proc/self/fd/1

SSLEngine on
SSLCertificateFile <span class="hljs-string">&quot;/etc/letsencrypt/live/www.defectink.com/fullchain.pem&quot;</span>
SSLCertificateKeyFile <span class="hljs-string">&quot;/etc/letsencrypt/live/www.defectink.com/privkey.pem&quot;</span>
&lt;FilesMatch <span class="hljs-string">&quot;\.(cgi|shtml|phtml|php)$&quot;</span>&gt;
    SSLOptions +StdEnvVars
&lt;/FilesMatch&gt;
&lt;Directory <span class="hljs-string">&quot;/usr/local/apache2/cgi-bin&quot;</span>&gt;
    SSLOptions +StdEnvVars
&lt;/Directory&gt;
BrowserMatch <span class="hljs-string">&quot;MSIE [2-5]&quot;</span> \
         nokeepalive ssl-unclean-shutdown \
         downgrade-1.0 force-response-1.0
CustomLog /proc/self/fd/1 \
          <span class="hljs-string">&quot;%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \&quot;%r\&quot; %b&quot;</span>

&lt;/VirtualHost&gt;                                  
</code></pre>
<p>这里的主要配置点就在<code>SSLCertificateFile</code>和<code>SSLCertificateKeyFile</code>。关于配合certbot申请证书，在前一篇水过。有兴趣的小伙伴可以去了解更多。<a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://www.defectink.com/defect/docker-build-own-images.html#menu_index_8">Docker - 构建属于自己的镜像<svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a>。</p>
<p>值得注意的是，在一个<code>httpd.conf</code>文件中只能有一个<code>Listen 443</code>字段。而默认的ssl配置文件中就包含一个<code>Listen 443</code>字段。当复制多个默认的配置文件时，会导致apache运行错误。因为所有的配置文件都会被引入到<code>httpd.conf</code>，而一个apache只能监听一次端口，也就是说只能有一个<code>Listen 443</code>在配置文件中。</p>
<p>可以考虑将其写在监听80端口下面：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash"><span class="hljs-comment">#Listen 12.34.56.78:80</span>
Listen 80
Listen 443
</code></pre>
<h3 id="日志">日志</h3>
<p>这里虚拟主机的默认配置时将日志发送到stdout和stderr。可以理解为输出到终端上。</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-ruby">    <span class="hljs-comment"># Send apache logs to stdout and stderr</span>
    CustomLog /<span class="hljs-built_in">proc</span>/<span class="hljs-keyword">self</span>/fd/<span class="hljs-number">1</span> common
    ErrorLog /<span class="hljs-built_in">proc</span>/<span class="hljs-keyword">self</span>/fd/<span class="hljs-number">2</span>
</code></pre>
<p>当然也可以实现日志的持久化保存。将其映射到宿主机的目录下就好了。</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-lua">    CustomLog /var/<span class="hljs-built_in">log</span>/access.<span class="hljs-built_in">log</span> common
    ErrorLog /var/<span class="hljs-built_in">log</span>/<span class="hljs-built_in">error</span>.<span class="hljs-built_in">log</span>
</code></pre>
<h2 id="php">PHP</h2>
<p>PHP这里使用fpm，配合docker-compose的内部网络与apache进行通信。</p>
<h3 id="dockerfile-1">Dockerfile</h3>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">FROM php:7.4-fpm-alpine
RUN <span class="hljs-built_in">mv</span> <span class="hljs-string">&quot;<span class="hljs-variable">$PHP_INI_DIR</span>/php.ini-production&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$PHP_INI_DIR</span>/php.ini&quot;</span>
COPY php.ini <span class="hljs-variable">$PHP_INI_DIR</span>/conf.d/
RUN sed -i <span class="hljs-string">&#x27;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#x27;</span> /etc/apk/repositories \
        &amp;&amp; apk update \
        &amp;&amp; apk upgrade \
        &amp;&amp; docker-php-ext-install mysqli \
        &amp;&amp; docker-php-ext-install pdo_mysql
</code></pre>
<h3 id="phpini">php.ini</h3>
<p>优雅的获取容器内的php.ini文件：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">docker <span class="hljs-built_in">cp</span> somephp:/usr/local/etc/php/ /root
</code></pre>
<p>修改过后的配置文件可以在Dockerfile中copy，也可以在compose.yml中映射。只要到了宿主机的正确位置就可以生效。</p>
<p>官方的描述是这样的方法：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-dockerfile">RUN mv &quot;$PHP_INI_DIR/php.ini-production&quot; &quot;$PHP_INI_DIR/php.ini&quot;
COPY php.ini $PHP_INI_DIR/conf.d/
</code></pre>
<h3 id="拓展">拓展</h3>
<p>如果需要安装typecho这样的blog程序的话，再连接sql时需要安装mysql的拓展，写在Dockerfile就好了：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs">docker-php-ext-install pdo_mysql
</code></pre>
<p>如果还需要其他的拓展的话，还可以在Dockerfile里自定义安装。可以使用<code>pecl</code>来安装，然后使用<code>docker-php-ext-enable</code>来启用它。</p>
<blockquote>
<p>use <code>pecl install</code> to download and compile it, then use <code>docker-php-ext-enable</code> to enable it:</p>
</blockquote>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-css"><span class="hljs-selector-tag">FROM</span> php:<span class="hljs-number">7.4</span>-cli
RUN pecl install redis-<span class="hljs-number">5.1</span>.<span class="hljs-number">1</span> \
    &amp;&amp; pecl install xdebug-<span class="hljs-number">2.8</span>.<span class="hljs-number">1</span> \
    &amp;&amp; docker-php-ext-enable redis xdebug
</code></pre>
<p>或者直接使用<code>docker-php-ext-install</code>来安装：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-markdown"><span class="hljs-code">    &amp;&amp; docker-php-ext-install mysqli \
    &amp;&amp; docker-php-ext-install pdo_mysql
</span></code></pre>
<p>至于更多的拓展，还可以编译安装：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">FROM php:5.6-cli
RUN curl -fsSL <span class="hljs-string">&#x27;https://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz&#x27;</span> -o xcache.tar.gz \
    &amp;&amp; <span class="hljs-built_in">mkdir</span> -p xcache \
    &amp;&amp; tar -xf xcache.tar.gz -C xcache --strip-components=1 \
    &amp;&amp; <span class="hljs-built_in">rm</span> xcache.tar.gz \
    &amp;&amp; ( \
        <span class="hljs-built_in">cd</span> xcache \
        &amp;&amp; phpize \
        &amp;&amp; ./configure --enable-xcache \
        &amp;&amp; make -j <span class="hljs-string">&quot;<span class="hljs-subst">$(nproc)</span>&quot;</span> \
        &amp;&amp; make install \
    ) \
    &amp;&amp; <span class="hljs-built_in">rm</span> -r xcache \
    &amp;&amp; docker-php-ext-enable xcache
</code></pre>
<h2 id="mysql">MySql</h2>
<p>mysql主要修改的一些配置使用启动时的环境变量就可以了，不需要修改其配置文件的情况下，便用不到Dockerfile了。直接使用官方的镜像就好了。</p>
<h3 id="docker-secrets">Docker Secrets</h3>
<p>如果担心密码写在docker-compose.yml里不安全的话，可以考虑使用docker secret。不过secret需要使用swarm集群。单台主机只使用docker-compose可能会更加方便一点。</p>
<p>并且在compose中生成的是两个虚拟网络，只有apache在前端网络映射了端口。mysql完全放在后端，除了虚拟网络和宿主机都无法与其通信。所以密码的安全并不用太过于担心。如果mysql需要对外提供服务，那就需要多担心一下了。</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-arduino">$ docker run --name some-mysql -e MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql-root -d mysql:tag
</code></pre>
<blockquote>
<p>映射了目录后，配置的密码都会被持久化保存。再次修改docker-compose.yml中的变量将不会生效。</p>
</blockquote>
<h3 id="数据持久化">数据持久化</h3>
<p>对于docker来说，尽量不要在容器内发生写的操作为好。此外，对于数据库来，数据肯定是需要持久化存储的。官方推荐的是：</p>
<blockquote>
<p>Important note: There are several ways to store data used by applications that run in Docker containers. We encourage users of the <code>mysql</code> images to familiarize themselves with the options available, including:</p>
<ul>
<li>Let Docker manage the storage of your database data <a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://docs.docker.com/engine/tutorials/dockervolumes/#adding-a-data-volume">by writing the database files to disk on the host system using its own internal volume management<svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a>. This is the default and is easy and fairly transparent to the user. The downside is that the files may be hard to locate for tools and applications that run directly on the host system, i.e. outside containers.</li>
<li>Create a data directory on the host system (outside the container) and <a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://docs.docker.com/engine/tutorials/dockervolumes/#mount-a-host-directory-as-a-data-volume">mount this to a directory visible from inside the container<svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a>. This places the database files in a known location on the host system, and makes it easy for tools and applications on the host system to access the files. The downside is that the user needs to make sure that the directory exists, and that e.g. directory permissions and other security mechanisms on the host system are set up correctly.</li>
</ul>
</blockquote>
<p>说白了就是映射出来为最佳解决方案。如果在compose.yml中使用<code>-v</code>映射，而不添加宿主机的目录位置的话。文件将会被映射到一个随机的目录。</p>
<p>推荐方案：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-perl">$ docker run --name some-mysql -v /<span class="hljs-keyword">my</span>/own/datadir:<span class="hljs-regexp">/var/li</span>b/mysql -e MYSQL_ROOT_PASSWORD=<span class="hljs-keyword">my</span>-secret-pw -d mysql:tag
</code></pre>
<h3 id="备份与恢复">备份与恢复</h3>
<p>针对单个或多个数据库都可以导出为sql文件。在docker中当然也是同样。甚至密码可以使用变量<code>$MYSQL_ROOT_PASSWORD</code>来代替。</p>
<p>导入：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">docker <span class="hljs-built_in">exec</span> -i mysql sh -c <span class="hljs-string">&#x27;exec mysql -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot; typecho&#x27;</span> &lt; /data/docker/typecho.sql
</code></pre>
<p>导出：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">docker <span class="hljs-built_in">exec</span> mysql sh -c <span class="hljs-string">&#x27;exec mysqldump typecho -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#x27;</span> &gt; /data/docker/mysql/backup/typecho.sql
</code></pre>
<h2 id="docker-compose">Docker-compose</h2>
<p>整个配置文件：</p>
<p>docker-compose.yml</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-dockerfile">version: &quot;3.2&quot;
services:
  php:
    container_name: php
    build: &#x27;./php/&#x27;
    networks:
      - backend
    volumes:
      - ./www/:/var/www/
  apache:
    container_name: apache
    build: &#x27;./apache/&#x27;
    depends_on:
      - php
      - mysql
    networks:
      - frontend
      - backend
    ports:
      - &quot;80:80&quot;
      - &quot;443:443&quot;
    volumes:
      - ./www/:/var/www/
      - /etc/letsencrypt/:/etc/letsencrypt/
      - ./apache/logs/:/var/log/
  mysql:
    container_name: mysql
    image: mysql:5.7
    volumes:
      - ./mysql/sqldata/:/var/lib/mysql
    networks:
      - backend
    environment:
      - MYSQL_ROOT_PASSWORD=password
    command: [&#x27;mysqld&#x27;, &#x27;--character-set-server=utf8mb4&#x27;]
  bark: 
    container_name: bark
    build: &#x27;./bark&#x27;
    ports: 
      - &quot;8181&quot;
    depends_on:
      - apache
    networks:
      - backend
networks:
  frontend:
  backend:
</code></pre>
<h3 id="网络">网络</h3>
<h2 id="问题">问题</h2>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-arduino">It does <span class="hljs-keyword">not</span> belong to any of <span class="hljs-keyword">this</span> network<span class="hljs-number">&#x27;</span>s subnets
</code></pre>
<p>这个问题很有意思，在配置文件中设置了网络段。也在服务下写了相同的地址段，它依然说我的网段不一样。</p>
<p>导致这个问题的原因是在自定义配置网段之前启动过相同的网络，在docker网络下它已经定义过网段了。再次重新手动指定网络地址时，会和之前的不一样。</p>
<p>只需要删除之前的网络，在重新运行<code>docker-sompose up</code>一遍就可以了。</p>
<p>查看网络：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">docker network <span class="hljs-built_in">ls</span>
</code></pre>
<p>删除：</p>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">docker network <span class="hljs-built_in">rm</span> docker_backend
</code></pre>
<h3 id="此外">此外</h3>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-markdown"><span class="hljs-bullet">   -</span> backend
<span class="hljs-code">	ipv4_address: 172.18.0.10
</span></code></pre>
<p>不同的语法写在一起也会导致错误。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://www.digitalocean.com/community/questions/how-to-set-the-default-virtual-host-on-apache-2">How to set the default virtual host on Apache 2?<svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a></li>
<li><a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://stackoverflow.com/questions/45648821/docker-compose-up-error-invalid-address">docker-compose up error, Invalid address<svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a></li>
<li><a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://docs.docker.com/compose/networking/">Networking in Compose<svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a></li>
<li><a target="_blank" rel="noopener noreferrer" class="chakra-link css-wox0k7" href="https://www.cloudreach.com/en/insights/blog/containerize-this-how-to-use-php-apache-mysql-within-docker-containers/">Containerize This! How to use PHP, Apache, MySQL within Docker containers<svg viewBox="0 0 24 24" focusable="false" class="chakra-icon css-2y6psj"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path></g></svg></a></li>
</ul>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-bash">docker run -it --<span class="hljs-built_in">rm</span> --name certbot \
   -v <span class="hljs-string">&quot;/etc/letsencrypt:/etc/letsencrypt&quot;</span> \
   -v <span class="hljs-string">&quot;/var/lib/letsencrypt:/var/lib/letsencrypt&quot;</span> \
   -v <span class="hljs-string">&quot;/data/docker/web/www/:/data/docker/web/www/&quot;</span> \
   certbot/certbot certonly -n --webroot \
   -w /data/docker/web/www/test -d test.defectink.com \
   -w /data/docker/web/www/html -d www.defectink.com \
   -w /data/docker/web/www/index -d index.defectink.com \
   -w /data/docker/web/www/api -d api.defectink.com
</code></pre>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-css">docker run <span class="hljs-attr">--rm</span> <span class="hljs-attr">--name</span> myadmin -d <span class="hljs-attr">--network</span> docker_backend <span class="hljs-attr">--link</span> mysql_db_server:mysql -e PMA_HOST=<span class="hljs-number">172.20</span>.<span class="hljs-number">0.4</span> -p <span class="hljs-number">3002</span>:<span class="hljs-number">80</span> phpmyadmin/phpmyadmin
</code></pre>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-css">certbot certonly -n <span class="hljs-attr">--webroot</span> -w /data/docker/web/www/<span class="hljs-selector-tag">html</span> -d www<span class="hljs-selector-class">.defectink</span><span class="hljs-selector-class">.com</span> <span class="hljs-attr">--post-hook</span> &quot;docker restart apache&quot;
</code></pre>
<pre><button type="button" class="chakra-button css-19bp9bt">COPY</button><code class="hljs language-css">certbot certonly -n <span class="hljs-attr">--webroot</span> -w /data/docker/web/www/<span class="hljs-selector-tag">html</span> -d www<span class="hljs-selector-class">.defectink</span><span class="hljs-selector-class">.com</span>
certbot certonly -n <span class="hljs-attr">--webroot</span> -w /data/docker/web/www/index -d index<span class="hljs-selector-class">.defectink</span><span class="hljs-selector-class">.com</span>
certbot certonly -n <span class="hljs-attr">--webroot</span> -w /data/docker/web/www/test -d test<span class="hljs-selector-class">.defectink</span><span class="hljs-selector-class">.com</span>
certbot certonly -n <span class="hljs-attr">--webroot</span> -w /data/docker/web/www/api -d api<span class="hljs-selector-class">.defectink</span><span class="hljs-selector-class">.com</span>
</code></pre></section></article></div><style data-emotion="css 1i6v8fa">.css-1i6v8fa{min-height:346px;}@media screen and (min-width: 30em){.css-1i6v8fa{min-height:350px;}}</style><div class="css-1i6v8fa"></div><style data-emotion="css 3ydw18">.css-3ydw18{height:3px;width:50px;background:var(--chakra-colors-gray-500);border-radius:var(--chakra-radii-xl);margin-top:2.5rem;}</style><div class="css-3ydw18"></div><style data-emotion="css 1lwvw50">.css-1lwvw50{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-flow:column;-webkit-flex-flow:column;-ms-flex-flow:column;flex-flow:column;padding-top:1.5rem;padding-bottom:1.5rem;}</style><footer class="css-1lwvw50"><style data-emotion="css yld109">.css-yld109{color:var(--chakra-colors-gray-600);font-weight:var(--chakra-fontWeights-bold);margin-bottom:0.5rem;}</style><p class="chakra-text css-yld109">©<!-- -->2022<!-- --> 小肥羊</p><style data-emotion="css 3eyczr">.css-3eyczr{color:var(--chakra-colors-gray-400);font-size:small;}</style><p class="chakra-text css-3eyczr">Powered by Next.js ❤️ Chakra UI</p></footer></div><style data-emotion="css kl7qz4">.css-kl7qz4{display:none;position:-webkit-sticky;position:sticky;top:3rem;margin-top:3rem;}@media screen and (min-width: 30em){.css-kl7qz4{display:none;}}@media screen and (min-width: 48em){.css-kl7qz4{display:none;}}@media screen and (min-width: 62em){.css-kl7qz4{display:block;}}</style><div class="css-kl7qz4"><h2 id="table-of-contents">Table of contents</h2>
<ul>
<li>
<p><a class="chakra-link css-wox0k7" href="#%E6%B6%89%E5%8F%8A%E5%88%B0%E7%9A%84%E6%93%8D%E4%BD%9C">涉及到的操作</a></p>
</li>
<li>
<p><a class="chakra-link css-wox0k7" href="#%E7%9B%AE%E5%89%8D%E7%8E%AF%E5%A2%83">目前环境</a></p>
</li>
<li>
<p><a class="chakra-link css-wox0k7" href="#%E5%AE%B9%E5%99%A8%E5%8C%96">容器化</a></p>
<ul>
<li><a class="chakra-link css-wox0k7" href="#%E6%80%9D%E8%B7%AF">思路</a></li>
</ul>
</li>
<li>
<p><a class="chakra-link css-wox0k7" href="#apahce">Apahce</a></p>
<ul>
<li><a class="chakra-link css-wox0k7" href="#dockerfile">Dockerfile</a></li>
<li><a class="chakra-link css-wox0k7" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">配置文件</a></li>
<li><a class="chakra-link css-wox0k7" href="#module">Module</a></li>
<li><a class="chakra-link css-wox0k7" href="#%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA">虚拟主机</a></li>
<li><a class="chakra-link css-wox0k7" href="#ssl">SSL</a></li>
<li><a class="chakra-link css-wox0k7" href="#%E6%97%A5%E5%BF%97">日志</a></li>
</ul>
</li>
<li>
<p><a class="chakra-link css-wox0k7" href="#php">PHP</a></p>
<ul>
<li><a class="chakra-link css-wox0k7" href="#dockerfile-1">Dockerfile</a></li>
<li><a class="chakra-link css-wox0k7" href="#phpini">php.ini</a></li>
<li><a class="chakra-link css-wox0k7" href="#%E6%8B%93%E5%B1%95">拓展</a></li>
</ul>
</li>
<li>
<p><a class="chakra-link css-wox0k7" href="#mysql">MySql</a></p>
<ul>
<li><a class="chakra-link css-wox0k7" href="#docker-secrets">Docker Secrets</a></li>
<li><a class="chakra-link css-wox0k7" href="#%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96">数据持久化</a></li>
<li><a class="chakra-link css-wox0k7" href="#%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D">备份与恢复</a></li>
</ul>
</li>
<li>
<p><a class="chakra-link css-wox0k7" href="#docker-compose">Docker-compose</a></p>
<ul>
<li><a class="chakra-link css-wox0k7" href="#%E7%BD%91%E7%BB%9C">网络</a></li>
</ul>
</li>
<li>
<p><a class="chakra-link css-wox0k7" href="#%E9%97%AE%E9%A2%98">问题</a></p>
<ul>
<li><a class="chakra-link css-wox0k7" href="#%E6%AD%A4%E5%A4%96">此外</a></li>
</ul>
</li>
<li>
<p><a class="chakra-link css-wox0k7" href="#%E5%8F%82%E8%80%83">参考</a></p>
</li>
</ul></div></div><span></span></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"docker-container-all","content":"\n自上篇[Docker - 构建属于自己的镜像](https://www.defectink.com/defect/docker-build-own-images.html)以来，发现Docker非常的有意思。主要是非常的方便，并且在可以跨平台的情况下部署环境对于以后迁移也是一件极其有利的事。研究了Dockerfile的编写以及实践。一些基础的实践之后，对于Docker的工作方式以及操作命令都有了一些熟悉。也逐渐了发现了它的一些优点。\n\n翻开自己的旧机器里的多种环境交杂在一起的配置，时间长了连配置文件在哪都找不到了。管理起来比较复杂。那些服务器的管理面板并不是很喜欢，而且相对于Docker来说，管理面板只是简化了部署的操作，并没有达到方便管理的目的。到最后可能它的软件目录，镜像源都是按照它的想法去放的。对于自己并没有完全的掌控。当然不能完全拿管理面板与Docker来相比，二者完全是两种技术。只是相较于方便管理这方面来对比一下。\n\n而最近研究的Docker，无疑是最满意的了。在保持宿主机不乱的情况下，可以完全的掌控自己的运行环境。于是就有了将自己目前跑了挺长时间的一套blog环境都迁移到Docker上。对于以后若是迁移机器也会更加的方便。\n\n## 涉及到的操作\n\n* Dockerfile\n* docker-compose.yml\n* apache virtualhost\n* php-fpm\n* http2\n* apache https\n* certbot with docker\n* apache proxy\n\n## 目前环境\n\n先来简单看下当前跑在机器上的环境：\n\n基本的LAMP环境，加上一些自定义的应用，与一个服务器监控软件。其中apache有多个虚拟主机，全部都使用了https。\n\n咋一看是一套很简单的环境，其中apache配置稍多一点。但是实际在迁移到Docker的操作起来还是比较复杂的。并且为了镜像的最小化，apache基于的镜像都是alpine。配置与常用的Ubuntu略有不同。\n\n## 容器化\n\n### 思路\n\n将多个运行LAMP分别拆分出三个运行环境，使用docker-compose来捆绑运行。\n\n目录树\n\n```\n.\n├── apache\n│   ├── Dockerfile\n│   ├── httpd.conf\n│   └── sites\n│       ├── 000-default-ssl.conf\n│       └── 000-default.conf\n├── docker-compose.yml\n├── mysql\n│   └── backup\n├── php\n│   └── Dockerfile\n└── www\n    └── html\n        └── index.php\n```\n\n首先创建一个用于存放整个运行环境的`Docker`父文件夹。然后根据不同的镜像来划分不同的子文件夹，子文件夹内存放的就是各个镜像的`Dockerfile`与配置文件等。将docker-compose.yml存放与父目录下。\n\napache与php-fpm通信借助Docker的网络，实现内部的通信。\n\n## Apahce\n\n在当前的apache目录下，主要文件夹的划分为`Dockerfile`、`httpd.conf`和sites文件夹。\n\n### Dockerfile\n\n虽然httpd有了一个单独的镜像，但是还是需要使用Dockerfile来对其进行自定义配置。为了尽量减小镜像的大小。这里使用基于alpine的apache。\n\n在Docker hub中的[httpd](https://hub.docker.com/_/httpd)当前支持的tag：\n\n![image-20191221185631177](../images/Docker全面容器化/image-20191221185631177.webp)\n\n整个Dockerfile：\n\n```dockerfile\nFROM httpd:alpine\nRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories \\\n\t\u0026\u0026 apk update \\\n        \u0026\u0026 apk upgrade\nCOPY sites/ /usr/local/apache2/conf/sites/\nCOPY httpd.conf /usr/local/apache2/conf/httpd.conf\n```\n\n所以`FROM`里使用的就是带alpine的tag了。我还尝试过测试使用基于alpine的空载运行apache大概节约了1MB的内存。\n\n```\n176d166ee52a        testa               0.00%             4.484MiB / 3.607GiB   0.12%         \n3dac39c11385        test                0.00%             5.664MiB / 3.607GiB   0.15%         \n```\n\n对于跑在国内的机器上，alpine也有国内的源。并且替换的也很简单，一句话就好了。这样在后续的更新源和安装软件就没有那么苦恼了。\n\n```\nsed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories\n```\n\n剩下的`COPY`就是复制自定义的配置文件到容器里去了。\n\n### 配置文件\n\n首先，之前的环境中apache是有多个虚拟主机，并且每个主机都启用了ssl以及一些其他的配置。所以第一步是需要修改容器的配置文件。也就是要先获取默认的配置文件。\n\n优雅的获取apache默认配置文件：\n\n```\ndocker run --rm httpd:2.4 cat /usr/local/apache2/conf/httpd.conf \u003e httpd.conf\n```\n\n默认的ssl配置文件：\n\n```\ndocker run --rm httpd:2.4 cat /usr/local/apache2/conf/extra/httpd-ssl.conf \u003e ssl.conf\n```\n\n容器的配置文件路径：\n\n```\n/usr/local/apache2/conf/httpd.conf\n```\n\n获取到了默认的配置文件之后，在apache的文件夹内可以先自定义`httpd.conf`。并且尝试启动一次，没用问题后可以继续配置虚拟主机。\n\n由于不同的站点都交给了虚拟主机的配置文件来处理。所以`httpd.conf`主要是负责一些mod的配置，和一些全局的配置了。还有就是将余下的配置文件`Include`进来了。\n\n后期还有需要添加更多的虚拟主机的配置文件，到时候一个一个的`Include`操作太过繁琐。所以创建个专门存放配置文件的文件夹，再在`httpd.conf`里将整个文件夹`Include`进去。这样就最简单的解决了操作繁琐的问题。\n\n创建一个`sites`文件夹用于存放配置文件，`COPY`到容器内相应的目录：\n\n```\nCOPY sites/ /usr/local/apache2/conf/sites/\n```\n\n在`httpd.conf`中相应的引入：\n\n```\nInclude /usr/local/apache2/conf/sites/*.conf\n```\n\n{*}这一操作方法还是学自Ubuntu下的apache，它的配置目录下有两个文件夹`sites-available`和`sites-enabled`。在主要的apache2.conf中引入配置文件。\n\n```http\n# Include generic snippets of statements\nIncludeOptional conf-enabled/*.conf\n\n# Include the virtual host configurations:\nIncludeOptional sites-enabled/*.conf\n```\n\n`httpd.conf`中的虚拟主机配置不需要修改了。所有的站点可以都在Include中的配置文件中准备。基本上`httpd.conf`就是为引入配置文件和启用mod所准备的。\n\n### Module\n\n在基于alpine中的apache，所有的mod加载都写在了配置文件`httpd.conf`里。只需要取消注释就可以加载/启用模组了。\n\n这次添加的module：\n\n```\nLoadModule deflate_module modules/mod_deflate.so\nLoadModule proxy_module modules/mod_proxy.so\nLoadModule proxy_connect_module modules/mod_proxy_connect.so\nLoadModule proxy_ftp_module modules/mod_proxy_ftp.so\nLoadModule proxy_http_module modules/mod_proxy_http.so\nLoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so\nLoadModule setenvif_module modules/mod_setenvif.so\nLoadModule mpm_event_module modules/mod_mpm_event.so\nLoadModule http2_module modules/mod_http2.so\nLoadModule proxy_http2_module modules/mod_proxy_http2.so\nLoadModule ssl_module modules/mod_ssl.so\nLoadModule socache_shmcb_module modules/mod_socache_shmcb.so\nLoadModule rewrite_module modules/mod_rewrite.so\nLoadModule headers_module modules/mod_headers.so\n#LoadModule mpm_prefork_module modules/mod_mpm_prefork.so\n```\n\n这些mod都是作用于何？\n\n* mod_deflate是一个压缩算法。\n\n* mod_socache_shmcb共享对象缓存提供程序。\n\n* 因为需要配置反代和与php-fpm工作，所以需要启用多个proxy配置文件。\n\n* 因为需要用到http2，所以工作模式得修改为event。同时注释掉默认的工作模式prefork。自然也需要mod_http2\n\n* https是不可或缺的，所以mod_ssl不可缺少。\n\n* 后续的博客需要用到伪静态，mod_rewrite也不可少。\n\n* 在最近也添加了多个header头，需要用到mod_headers。\n\n\u003e info：根据自己需要启用module是一个良好的习惯，过多的module会影响性能。\n\n### 虚拟主机\n\n前面提到，专门创建了一个sites文件夹来存放虚拟主机的配置文件，目前sites文件夹还是空的。既然`httpd.conf`以及准备就绪，那么接下来就是填满sites文件夹了。\n\n在还未添加虚拟主机时，默认的站点配置文件全部都写在`httpd.conf`里。默认的根目录在htdocs。所以在第一次启动测试时，访问的时这里的html文件。\n\n```\nDocumentRoot \"/usr/local/apache2/htdocs\"\n```\n\n这里的配置可以不用动，全部操作交给虚拟主机就好。\n\n整个虚拟主机（default.conf）配置文件：\n\n```\n\u003cVirtualHost *:80\u003e\nProtocolsHonorOrder On\nProtocols h2 h2c\nHeader set X-Frame-Options \"SAMEORIGIN\"\nHeader always set Strict-Transport-Security \"max-age=63072000; includeSubdomains;\"\nHeader set Content-Security-Policy \"default-src 'self' https://cdn.defectink.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://maxcdn.bootstrapcdn.com https://ajax.googleapis.com https://cdn.defectink.com; img-src *; style-src 'self' 'unsafe-inline' https://cdn.defectink.com https://maxcdn.bootstrapcdn.com https://fonts.googleapis.com/; font-src 'self' https://cdn.defectink.com https://fonts.gstatic.com/ https://maxcdn.bootstrapcdn.com; form-action 'self' https://cdn.defectink.com; upgrade-insecure-requests;\"\nHeader set X-Content-Type-Options nosniff\nHeader always set Referrer-Policy \"no-referrer-when-downgrade\"\nHeader always set Feature-Policy \"vibrate 'self'; sync-xhr 'self' https://cdn.defectink.com https://www.defectink.com\"\n    # Proxy .php requests to port 9000 of the php-fpm container\n    ProxyPassMatch ^/(.*\\.php(/.*)?)$ fcgi://php:9000/var/www/html/$1\n    ServerName www.defectink.com\n    DocumentRoot /var/www/html/\n    \u003cDirectory /var/www/html/\u003e\n        DirectoryIndex index.php\n        Options Indexes FollowSymLinks\n        AllowOverride All\n        Require all granted\n    \u003c/Directory\u003e\n    # Send apache logs to stdout and stderr\n    CustomLog /proc/self/fd/1 common\n    ErrorLog /proc/self/fd/2\nRewriteEngine on\nRewriteCond %{SERVER_NAME} =www.defectink.com\nRewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]\n\u003c/VirtualHost\u003e\n```\n\n#### 虚拟主机优先级\n\n在apache中，虚拟主机的配置文件是拥有优先级的。优先级的意思就是，当一个域名指向当前机器的ip，而配置文件中没有绑定的ServerName时，默认被引导到的页面。\n\n优先级的顺序是根据虚拟主机的配置文件名来决定的。名称首字母越靠前，优先级越高。使用数字开头将大于子母开头。\n\n\u003e 000-default will be the default, because it goes “numbers, then letters”.\n\n可以使用命令来查看当前的默认站点：\n\n```bash\nhttpd -S\n```\n\n```bash\napache2ctl -S\n```\n\n### SSL\n\n这里的ssl配置文件是来自于容器内的默认配置文件，使用上述的方法可以很方便的导出。\n\n整个ssl（default-ssl.conf）配置文件：\n\n```\nListen 443\n\nSSLCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES\nSSLProxyCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES\nSSLHonorCipherOrder on \nSSLProtocol all -SSLv3\nSSLProxyProtocol all -SSLv3\nSSLPassPhraseDialog  builtin\nSSLSessionCache        \"shmcb:/usr/local/apache2/logs/ssl_scache(512000)\"\nSSLSessionCacheTimeout  300\n\n\u003cVirtualHost *:443\u003e\nProtocolsHonorOrder On\nProtocols h2 h2c\nHeader set X-Frame-Options \"SAMEORIGIN\"\nHeader always set Strict-Transport-Security \"max-age=63072000; includeSubdomains;\"\nHeader set Content-Security-Policy \"default-src 'self' https://cdn.defectink.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://maxcdn.bootstrapcdn.com https://ajax.googleapis.com https://cdn.defectink.com; img-src *; style-src 'self' 'unsafe-inline' https://cdn.defectink.com https://maxcdn.bootstrapcdn.com https://fonts.googleapis.com/; font-src 'self' https://cdn.defectink.com https://fonts.gstatic.com/ https://maxcdn.bootstrapcdn.com; form-action 'self' https://cdn.defectink.com; upgrade-insecure-requests;\"\nHeader set X-Content-Type-Options nosniff\nHeader always set Referrer-Policy \"no-referrer-when-downgrade\"\nHeader always set Feature-Policy \"vibrate 'self'; sync-xhr 'self' https://cdn.defectink.com https://www.defectink.com\"\n# Proxy .php requests to port 9000 of the php-fpm container\nProxyPassMatch ^/(.*\\.php(/.*)?)$ fcgi://php:9000/var/www/html/$1\n# General setup for the virtual host\nDocumentRoot \"/var/www/html/\"\nServerName www.defectink.com:443\nServerAdmin i@defect.ink\n    \u003cDirectory /var/www/html/\u003e\n        DirectoryIndex index.php\n        Options Indexes FollowSymLinks\n        AllowOverride All\n        Require all granted\n    \u003c/Directory\u003e\nErrorLog /proc/self/fd/2\nTransferLog /proc/self/fd/1\n\nSSLEngine on\nSSLCertificateFile \"/etc/letsencrypt/live/www.defectink.com/fullchain.pem\"\nSSLCertificateKeyFile \"/etc/letsencrypt/live/www.defectink.com/privkey.pem\"\n\u003cFilesMatch \"\\.(cgi|shtml|phtml|php)$\"\u003e\n    SSLOptions +StdEnvVars\n\u003c/FilesMatch\u003e\n\u003cDirectory \"/usr/local/apache2/cgi-bin\"\u003e\n    SSLOptions +StdEnvVars\n\u003c/Directory\u003e\nBrowserMatch \"MSIE [2-5]\" \\\n         nokeepalive ssl-unclean-shutdown \\\n         downgrade-1.0 force-response-1.0\nCustomLog /proc/self/fd/1 \\\n          \"%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \\\"%r\\\" %b\"\n\n\u003c/VirtualHost\u003e                                  \n```\n\n这里的主要配置点就在`SSLCertificateFile`和`SSLCertificateKeyFile`。关于配合certbot申请证书，在前一篇水过。有兴趣的小伙伴可以去了解更多。[Docker - 构建属于自己的镜像](https://www.defectink.com/defect/docker-build-own-images.html#menu_index_8)。\n\n值得注意的是，在一个`httpd.conf`文件中只能有一个`Listen 443`字段。而默认的ssl配置文件中就包含一个`Listen 443`字段。当复制多个默认的配置文件时，会导致apache运行错误。因为所有的配置文件都会被引入到`httpd.conf`，而一个apache只能监听一次端口，也就是说只能有一个`Listen 443`在配置文件中。\n\n可以考虑将其写在监听80端口下面：\n\n```\n#Listen 12.34.56.78:80\nListen 80\nListen 443\n```\n\n### 日志\n\n这里虚拟主机的默认配置时将日志发送到stdout和stderr。可以理解为输出到终端上。\n\n```\n    # Send apache logs to stdout and stderr\n    CustomLog /proc/self/fd/1 common\n    ErrorLog /proc/self/fd/2\n```\n\n当然也可以实现日志的持久化保存。将其映射到宿主机的目录下就好了。\n\n```\n    CustomLog /var/log/access.log common\n    ErrorLog /var/log/error.log\n```\n\n## PHP\n\nPHP这里使用fpm，配合docker-compose的内部网络与apache进行通信。\n\n### Dockerfile\n\n```\nFROM php:7.4-fpm-alpine\nRUN mv \"$PHP_INI_DIR/php.ini-production\" \"$PHP_INI_DIR/php.ini\"\nCOPY php.ini $PHP_INI_DIR/conf.d/\nRUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories \\\n        \u0026\u0026 apk update \\\n        \u0026\u0026 apk upgrade \\\n        \u0026\u0026 docker-php-ext-install mysqli \\\n        \u0026\u0026 docker-php-ext-install pdo_mysql\n```\n\n### php.ini\n\n优雅的获取容器内的php.ini文件：\n\n```\ndocker cp somephp:/usr/local/etc/php/ /root\n```\n\n修改过后的配置文件可以在Dockerfile中copy，也可以在compose.yml中映射。只要到了宿主机的正确位置就可以生效。\n\n官方的描述是这样的方法：\n\n```dockerfile\nRUN mv \"$PHP_INI_DIR/php.ini-production\" \"$PHP_INI_DIR/php.ini\"\nCOPY php.ini $PHP_INI_DIR/conf.d/\n```\n\n### 拓展\n\n如果需要安装typecho这样的blog程序的话，再连接sql时需要安装mysql的拓展，写在Dockerfile就好了：\n\n```\ndocker-php-ext-install pdo_mysql\n```\n\n如果还需要其他的拓展的话，还可以在Dockerfile里自定义安装。可以使用`pecl`来安装，然后使用`docker-php-ext-enable`来启用它。\n\n\u003e use `pecl install` to download and compile it, then use `docker-php-ext-enable` to enable it:\n\n```\nFROM php:7.4-cli\nRUN pecl install redis-5.1.1 \\\n    \u0026\u0026 pecl install xdebug-2.8.1 \\\n    \u0026\u0026 docker-php-ext-enable redis xdebug\n```\n\n或者直接使用`docker-php-ext-install`来安装：\n\n        \u0026\u0026 docker-php-ext-install mysqli \\\n        \u0026\u0026 docker-php-ext-install pdo_mysql\n至于更多的拓展，还可以编译安装：\n\n```\nFROM php:5.6-cli\nRUN curl -fsSL 'https://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz' -o xcache.tar.gz \\\n    \u0026\u0026 mkdir -p xcache \\\n    \u0026\u0026 tar -xf xcache.tar.gz -C xcache --strip-components=1 \\\n    \u0026\u0026 rm xcache.tar.gz \\\n    \u0026\u0026 ( \\\n        cd xcache \\\n        \u0026\u0026 phpize \\\n        \u0026\u0026 ./configure --enable-xcache \\\n        \u0026\u0026 make -j \"$(nproc)\" \\\n        \u0026\u0026 make install \\\n    ) \\\n    \u0026\u0026 rm -r xcache \\\n    \u0026\u0026 docker-php-ext-enable xcache\n```\n\n## MySql\n\nmysql主要修改的一些配置使用启动时的环境变量就可以了，不需要修改其配置文件的情况下，便用不到Dockerfile了。直接使用官方的镜像就好了。\n\n### Docker Secrets\n\n如果担心密码写在docker-compose.yml里不安全的话，可以考虑使用docker secret。不过secret需要使用swarm集群。单台主机只使用docker-compose可能会更加方便一点。\n\n并且在compose中生成的是两个虚拟网络，只有apache在前端网络映射了端口。mysql完全放在后端，除了虚拟网络和宿主机都无法与其通信。所以密码的安全并不用太过于担心。如果mysql需要对外提供服务，那就需要多担心一下了。\n\n```\n$ docker run --name some-mysql -e MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql-root -d mysql:tag\n```\n\n\u003e 映射了目录后，配置的密码都会被持久化保存。再次修改docker-compose.yml中的变量将不会生效。\n\n### 数据持久化\n\n对于docker来说，尽量不要在容器内发生写的操作为好。此外，对于数据库来，数据肯定是需要持久化存储的。官方推荐的是：\n\n\u003e Important note: There are several ways to store data used by applications that run in Docker containers. We encourage users of the `mysql` images to familiarize themselves with the options available, including:\n\u003e\n\u003e - Let Docker manage the storage of your database data [by writing the database files to disk on the host system using its own internal volume management](https://docs.docker.com/engine/tutorials/dockervolumes/#adding-a-data-volume). This is the default and is easy and fairly transparent to the user. The downside is that the files may be hard to locate for tools and applications that run directly on the host system, i.e. outside containers.\n\u003e - Create a data directory on the host system (outside the container) and [mount this to a directory visible from inside the container](https://docs.docker.com/engine/tutorials/dockervolumes/#mount-a-host-directory-as-a-data-volume). This places the database files in a known location on the host system, and makes it easy for tools and applications on the host system to access the files. The downside is that the user needs to make sure that the directory exists, and that e.g. directory permissions and other security mechanisms on the host system are set up correctly.\n\n说白了就是映射出来为最佳解决方案。如果在compose.yml中使用`-v`映射，而不添加宿主机的目录位置的话。文件将会被映射到一个随机的目录。\n\n推荐方案：\n\n```\n$ docker run --name some-mysql -v /my/own/datadir:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:tag\n```\n\n### 备份与恢复\n\n针对单个或多个数据库都可以导出为sql文件。在docker中当然也是同样。甚至密码可以使用变量`$MYSQL_ROOT_PASSWORD`来代替。\n\n导入：\n\n```bash\ndocker exec -i mysql sh -c 'exec mysql -uroot -p\"$MYSQL_ROOT_PASSWORD\" typecho' \u003c /data/docker/typecho.sql\n```\n\n导出：\n\n```bash\ndocker exec mysql sh -c 'exec mysqldump typecho -uroot -p\"$MYSQL_ROOT_PASSWORD\"' \u003e /data/docker/mysql/backup/typecho.sql\n```\n\n## Docker-compose\n\n整个配置文件：\n\ndocker-compose.yml\n\n```dockerfile\nversion: \"3.2\"\nservices:\n  php:\n    container_name: php\n    build: './php/'\n    networks:\n      - backend\n    volumes:\n      - ./www/:/var/www/\n  apache:\n    container_name: apache\n    build: './apache/'\n    depends_on:\n      - php\n      - mysql\n    networks:\n      - frontend\n      - backend\n    ports:\n      - \"80:80\"\n      - \"443:443\"\n    volumes:\n      - ./www/:/var/www/\n      - /etc/letsencrypt/:/etc/letsencrypt/\n      - ./apache/logs/:/var/log/\n  mysql:\n    container_name: mysql\n    image: mysql:5.7\n    volumes:\n      - ./mysql/sqldata/:/var/lib/mysql\n    networks:\n      - backend\n    environment:\n      - MYSQL_ROOT_PASSWORD=password\n    command: ['mysqld', '--character-set-server=utf8mb4']\n  bark: \n    container_name: bark\n    build: './bark'\n    ports: \n      - \"8181\"\n    depends_on:\n      - apache\n    networks:\n      - backend\nnetworks:\n  frontend:\n  backend:\n```\n\n### 网络\n\n## 问题\n\n```\nIt does not belong to any of this network's subnets\n```\n\n这个问题很有意思，在配置文件中设置了网络段。也在服务下写了相同的地址段，它依然说我的网段不一样。\n\n导致这个问题的原因是在自定义配置网段之前启动过相同的网络，在docker网络下它已经定义过网段了。再次重新手动指定网络地址时，会和之前的不一样。\n\n只需要删除之前的网络，在重新运行`docker-sompose up`一遍就可以了。\n\n查看网络：\n\n```bash\ndocker network ls\n```\n\n删除：\n\n```bash\ndocker network rm docker_backend\n```\n\n### 此外\n\n```\n   - backend\n\tipv4_address: 172.18.0.10\n```\n\n不同的语法写在一起也会导致错误。\n\n## 参考\n\n* [How to set the default virtual host on Apache 2?](https://www.digitalocean.com/community/questions/how-to-set-the-default-virtual-host-on-apache-2)\n* [docker-compose up error, Invalid address](https://stackoverflow.com/questions/45648821/docker-compose-up-error-invalid-address)\n* [Networking in Compose](https://docs.docker.com/compose/networking/)\n* [Containerize This! How to use PHP, Apache, MySQL within Docker containers](https://www.cloudreach.com/en/insights/blog/containerize-this-how-to-use-php-apache-mysql-within-docker-containers/)\n\n```\ndocker run -it --rm --name certbot \\\n   -v \"/etc/letsencrypt:/etc/letsencrypt\" \\\n   -v \"/var/lib/letsencrypt:/var/lib/letsencrypt\" \\\n   -v \"/data/docker/web/www/:/data/docker/web/www/\" \\\n   certbot/certbot certonly -n --webroot \\\n   -w /data/docker/web/www/test -d test.defectink.com \\\n   -w /data/docker/web/www/html -d www.defectink.com \\\n   -w /data/docker/web/www/index -d index.defectink.com \\\n   -w /data/docker/web/www/api -d api.defectink.com\n```\n\n```\ndocker run --rm --name myadmin -d --network docker_backend --link mysql_db_server:mysql -e PMA_HOST=172.20.0.4 -p 3002:80 phpmyadmin/phpmyadmin\n```\n\n```\ncertbot certonly -n --webroot -w /data/docker/web/www/html -d www.defectink.com --post-hook \"docker restart apache\"\n```\n\n```\ncertbot certonly -n --webroot -w /data/docker/web/www/html -d www.defectink.com\ncertbot certonly -n --webroot -w /data/docker/web/www/index -d index.defectink.com\ncertbot certonly -n --webroot -w /data/docker/web/www/test -d test.defectink.com\ncertbot certonly -n --webroot -w /data/docker/web/www/api -d api.defectink.com\n```\n\n","desc":"自上篇Docker - 构建属于自己的镜像以来，发现Docker非常的有意思。主要是非常的方便，并且在可以跨平台的情况下部署环境对于以后迁移也是一件极其有利的事。研究了Dockerfile的编写以及实...","title":"Docker-全面容器化！","date":"2019-12-19T11:11:33.000Z","tags":"Linux","categories":"实践","url":"docker-container-all","index_img":"/images/Docker全面容器化/logo.webp"}},"__N_SSG":true},"page":"/p/[slug]","query":{"slug":"docker-container-all"},"buildId":"k6NIc4JfXUsE09z9QnALx","isFallback":false,"dynamicIds":[3419,6929,1189,9125,3780,2980,5106],"gsp":true,"scriptLoader":[]}</script></body></html>